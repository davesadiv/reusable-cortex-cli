name: Reusable Cortex CLI Scan

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Name of the docker image to build and scan'
        required: true
        type: string
      wait_time:
        description: 'Time to wait for Cortex results'
        required: false
        type: string
        default: '900'
      node_version:
        description: 'Node version for AppSec scan'
        required: false
        type: string
        default: '22'
    secrets:
      CORTEX_API_KEY:
        required: true
      CORTEX_API_KEY_ID:
        required: true
      CORTEX_API_URL:
        required: true

jobs:
  scan:
    runs-on: ubuntu-latest
    env:
      CORTEX_API_KEY: ${{ secrets.CORTEX_API_KEY }}
      CORTEX_API_KEY_ID: ${{ secrets.CORTEX_API_KEY_ID }}
      CORTEX_API_URL: ${{ secrets.CORTEX_API_URL }}
      IMAGE_NAME: ${{ inputs.image_name }}
      WAIT: ${{ inputs.wait_time }}
      OUTPUT_FILE: 'scan-results.json'

    steps:
      - name: Checkout Caller Repo
        uses: actions/checkout@v4

      - name: Download cortexcli
        run: |
          crtx_resp=$(curl -H "x-xdr-auth-id: ${CORTEX_API_KEY_ID}" -H "Authorization: ${CORTEX_API_KEY}" "${CORTEX_API_URL}/public_api/v1/unified-cli/releases/download-link?os=linux&architecture=amd64")
          crtx_url=$(echo $crtx_resp | jq -r ".signed_url")
          curl -o cortexcli $crtx_url
          chmod +x cortexcli

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}

      - name: Run Cortex CLI Code Scan
        run: |
          ./cortexcli \
            --api-base-url "${CORTEX_API_URL}" \
            --api-key "${CORTEX_API_KEY}" \
            --api-key-id "${CORTEX_API_KEY_ID}" \
            code scan \
            --directory "${{ github.workspace }}" \
            --repo-id "${{ github.repository }}" \
            --branch "${{ github.ref_name }}" \
            --source "GITHUB_ACTIONS" \
            --create-repo-if-missing \
            --output json \
            --output-file-path "appsec-${{ env.OUTPUT_FILE }}"

      - name: CWP Image Scan Dependency
        run: sudo apt install libhyperscan5 jq -y

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Image
        run: |
          docker build -t "${IMAGE_NAME}" .
          echo "IMAGE_ID=$(docker inspect ${IMAGE_NAME} --format='{{.Id}}')" >> $GITHUB_ENV

      - name: Cortex CLI Image Scan
        run: |
          sudo ./cortexcli \
            --api-base-url "${CORTEX_API_URL}" \
            --api-key "${CORTEX_API_KEY}" \
            --api-key-id "${CORTEX_API_KEY_ID}" \
            --soft-fail \
            image scan \
            --timeout 600 \
            --name "${IMAGE_NAME}" \
            "${IMAGE_NAME}"

      - name: Get Results (XQL Polling)
        run: |
          echo "Starting XQL query for Image ID: ${IMAGE_ID}"
          # Payload construction using jq for safety
          payload=$(jq -n --arg id "$IMAGE_ID" '{request_data: {query: ("dataset = findings | filter xdm.finding.asset_name = \"" + $id + "\"")}}' )
          
          start_response=$(curl -s -X POST -H "Content-Type: application/json" -H "Authorization: ${CORTEX_API_KEY}" -H "x-xdr-auth-id: ${CORTEX_API_KEY_ID}" "${CORTEX_API_URL}/public_api/v1/xql/start_xql_query" -d "$payload")
          query_id=$(echo "$start_response" | jq -r '.reply')

          if [[ "$query_id" == "null" ]]; then exit 1; fi

          status="PENDING"
          while [[ "$status" == "PENDING" ]]; do
              sleep 20
              results_response=$(curl -s -X POST -H "Content-Type: application/json" -H "Authorization: ${CORTEX_API_KEY}" -H "x-xdr-auth-id: ${CORTEX_API_KEY_ID}" "${CORTEX_API_URL}/public_api/v1/xql/get_query_results" -d "{\"request_data\": {\"query_id\": \"$query_id\", \"pending_flag\": true, \"limit\": 100, \"format\": \"json\"}}")
              status=$(echo "$results_response" | jq -r '.reply.status')
          done
          
          echo "$results_response" | jq '.reply.results.data' > "image-${{ env.OUTPUT_FILE }}"

      - name: Upload All Results
        uses: actions/upload-artifact@v4
        with:
          name: cortex-scan-results
          path: |
            appsec-scan-results.json
            image-scan-results.json
